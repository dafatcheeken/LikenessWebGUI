import streamlit as st
import clip
import torch
import numpy as np
from PIL import Image

bg = '''
<style>
.stApp {
  background: radial-gradient(50% 50% at 50% 50%,#9ae0f6 0,#e6e6e6 100%);
}
</style>
'''

#likenessArr = np.load('LikenessArray.npy')

st.markdown(bg, unsafe_allow_html=True)


header = st.container()
body = st.container()
imagebox = st.empty()

likenesseval = st.empty()
likenesseval.markdown("<br><br><br><br><br><br><br><br>Current Likeness: ", unsafe_allow_html = True)

@st.cache(ttl=60)
def update_image():
    imagebox.image(picture)
    image1 = Image.open(picture)
    with torch.no_grad():
        image = preprocess(image1).unsqueeze(0).to(device)
        image_features = model.encode_image(image).numpy()
    likenesseval.write("Current Likeness: "+ str(round(likeness_score(image_features)[0],4)))

device = "cuda" if torch.cuda.is_available() else "cpu"

@st.cache
def load_model():
  return clip.load("ViT-B/32", device=device)

model, preprocess = load_model()

def sigmoid(x):
    return 1/(np.exp(-x) + 1)

def likeness_score(embed):
    return sigmoid(embed @ np.array([-2.77857959e-01,  3.07887554e-01,  3.53988588e-01,  3.26198898e-02,
        3.89573574e-01,  4.16270979e-02,  2.69757181e-01, -2.11735263e-01,
       -9.10049975e-02, -8.86643603e-02, -2.92587042e-01, -2.72002131e-01,
        4.08657640e-01, -6.52932405e-01, -3.28535467e-01,  6.71048522e-01,
        6.95453346e-01, -2.06705615e-01,  2.13589713e-01,  5.48205793e-01,
        5.19698441e-01, -1.72603816e-01,  7.16705993e-02,  2.25053594e-01,
       -2.36421123e-01,  8.26165006e-02,  2.04713732e-01, -4.86927815e-02,
        2.33762890e-01,  4.44759846e-01,  2.07822621e-01,  3.52150947e-02,
        5.41406497e-02,  2.67578736e-02, -8.53573531e-02, -3.47121447e-01,
        2.44780406e-01,  1.24415830e-01,  6.17773354e-01,  1.38925701e-01,
       -3.07979554e-01,  3.04204971e-01,  5.73066413e-01, -1.74594417e-01,
       -1.66710004e-01,  6.61721639e-03, -2.66213655e-01,  3.67078513e-01,
       -4.64811742e-01,  2.88878493e-02,  1.81209788e-01,  3.51717979e-01,
       -6.62225842e-01, -9.81699079e-02,  5.61360538e-01, -4.97550070e-02,
        6.51471764e-02, -3.30951959e-02,  3.74806851e-01, -2.12090462e-01,
        3.09650958e-01,  1.02327624e-03,  3.31714779e-01, -1.48897469e-01,
        2.94302613e-01, -2.29548544e-01, -6.76921755e-02,  4.23695669e-02,
        7.59113193e-01, -4.40267771e-02, -7.92805031e-02, -2.29664683e-01,
        3.48966777e-01, -1.56099290e-01,  4.30944860e-02,  1.87837303e-01,
       -2.06702068e-01, -5.46886623e-02,  8.33014697e-02,  2.28454500e-01,
       -1.37222156e-01, -3.06324810e-01, -4.08408612e-01, -5.96307993e-01,
        1.26579374e-01, -1.97807312e-01, -2.36738116e-01, -3.46928477e-01,
        4.47707683e-01,  2.05554247e-01,  5.31644702e-01,  1.41296923e-01,
        1.77843958e-01, -3.42021763e-01, -4.20745879e-01,  3.61796111e-01,
       -4.50460017e-02,  6.45746589e-02,  9.01121870e-02,  1.22348271e-01,
        4.84096184e-02, -9.46298018e-02, -5.28883278e-01,  2.20582455e-01,
        1.71605960e-01, -3.18432525e-02,  1.00404814e-01,  3.53446424e-01,
        5.14737964e-01, -5.70384443e-01, -3.30394030e-01, -4.31876898e-01,
        1.52645648e-01, -4.29985344e-01, -9.60894674e-03, -1.75782368e-01,
        3.15344781e-01,  6.09632544e-02, -6.29431605e-01,  3.06523204e-01,
       -4.47294265e-01,  1.77694678e-01,  2.07760870e-01,  6.31618619e-01,
        3.59214097e-01,  2.07517028e-01, -4.40995768e-02, -1.14799842e-01,
       -1.03127375e-01,  2.59976014e-02,  2.48519152e-01, -5.90019822e-02,
       -2.75715262e-01, -5.93602359e-02,  3.57875526e-01, -9.70598385e-02,
       -3.91175151e-02,  5.90142868e-02, -3.62125002e-02,  3.88934538e-02,
        6.88859105e-01, -1.97141230e-01,  5.88616580e-02,  3.23623657e-01,
       -1.45354316e-01,  3.17129642e-02,  6.76503778e-03, -1.46137297e-01,
        1.13866873e-01,  1.27845034e-01, -1.59884855e-01, -2.82366052e-02,
       -4.80562538e-01,  1.21486224e-01,  3.88787314e-03, -3.86492044e-01,
        5.85615411e-02, -1.55253232e-01, -4.68775164e-03, -1.33490786e-01,
        5.39676607e-01,  4.81082171e-01,  2.25501701e-01,  1.42865852e-01,
       -2.61531264e-01,  7.08588660e-02, -3.46936911e-01,  3.53867799e-01,
       -2.48390481e-01, -8.32265895e-03,  4.11057234e-01,  1.58170074e-01,
       -1.02426589e-01,  2.29170933e-01, -3.48690867e-01,  1.64328441e-01,
        1.89551622e-01, -1.63834706e-01,  1.24908581e-01,  1.70048654e-01,
        5.78400433e-01, -5.69456443e-03, -2.65991427e-02,  1.85945675e-01,
       -2.16902599e-01,  5.05327620e-02,  3.27691168e-01, -1.96581483e-01,
       -7.98081607e-02,  1.67885870e-02,  6.00560963e-01, -1.55103415e-01,
       -2.25630868e-02,  2.63972096e-02, -5.29203117e-02,  3.16232890e-02,
       -6.07362613e-02,  4.12820518e-01,  1.49753630e-01, -2.63334960e-02,
        1.70794398e-01,  4.29371387e-01,  1.85513347e-01, -3.49656582e-01,
        2.00960666e-01, -4.73737568e-01, -5.68560176e-02,  4.53119844e-01,
        2.22106159e-01, -2.36222595e-01,  3.31387907e-01, -2.33371481e-01,
       -4.23312038e-01, -2.39208899e-02,  1.48254395e-01,  1.32803217e-01,
        8.67094770e-02, -2.39467904e-01,  1.16372831e-01,  2.81383097e-01,
        5.26641488e-01,  2.60157436e-01,  1.59434527e-01, -2.88660377e-01,
        1.07520130e-02,  3.41375262e-01, -8.15976918e-01, -2.08828062e-01,
       -4.85621318e-02,  3.20114017e-01,  2.44671583e-01, -1.31054223e-01,
       -5.75666428e-01, -2.38987133e-01, -8.49497139e-01,  5.36201820e-02,
       -8.64269286e-02,  4.15461272e-01, -9.78278071e-02, -1.46384642e-01,
        4.69741486e-02, -3.99127096e-01, -1.55273020e-01,  7.47668892e-02,
       -9.22366157e-02,  2.82608032e-01,  1.77245890e-03,  2.41228119e-02,
        3.71146441e-01,  5.32098860e-03,  6.02781832e-01, -3.57944608e-01,
       -4.27799076e-01, -5.80805659e-01, -5.59618808e-02,  4.21484932e-02,
       -5.98706752e-02, -1.23381346e-01,  3.40836078e-01, -2.74514169e-01,
        3.79310213e-02, -4.25166488e-01,  3.28057885e-01, -3.96734536e-01,
        6.99029714e-02,  1.89701736e-01, -2.96818346e-01,  2.75207222e-01,
       -1.40667170e-01, -1.66795552e-01, -3.87560278e-02, -1.95716828e-01,
        1.52002230e-01, -4.12099838e-01, -3.83332402e-01,  7.54761040e-01,
        4.89796221e-01,  4.61421520e-01,  1.86224312e-01,  1.39354214e-01,
        2.88405605e-02,  4.49697614e-01, -2.63065308e-01, -1.92206115e-01,
        9.62124914e-02,  6.90107048e-02, -3.64835739e-01,  2.31118500e-01,
        4.55198646e-01, -3.54087472e-01, -1.09313585e-01,  5.10580182e-01,
        2.96865642e-01,  1.17635712e-01, -2.16902979e-02, -1.56811416e-01,
       -3.08032073e-02,  3.11718047e-01,  5.15333414e-01, -6.65476620e-02,
       -3.70631903e-01,  2.38101594e-02,  8.87581259e-02,  1.29907608e-01,
       -1.28674954e-01,  3.81209731e-01,  1.75620317e-01, -3.51885185e-02,
        2.80923992e-01, -6.14013597e-02, -1.50317878e-01, -1.98433161e-01,
       -6.05570078e-02, -3.49727981e-02, -1.95493549e-03, -1.45104185e-01,
       -2.20940471e-01,  1.93751156e-01,  1.77440122e-01, -1.78776115e-01,
       -1.59987584e-01, -2.14394361e-01, -3.78910244e-01, -2.65483141e-01,
       -1.33658320e-01, -4.34134424e-01,  2.75294453e-01,  4.26907837e-01,
        4.06979769e-01, -3.18558477e-02,  6.55141659e-04,  1.87947676e-01,
       -2.36110657e-01,  1.54894471e-01, -3.88991594e-01,  6.94845915e-02,
        1.73168957e-01, -3.62434715e-01,  3.44815671e-01,  2.58617580e-01,
       -9.69580114e-02, -1.96575806e-01, -9.31606740e-02,  2.24024244e-02,
        5.17098725e-01, -2.09872484e-01, -9.46730375e-02, -3.29806209e-01,
        1.76534876e-01,  3.72039557e-01,  2.68116266e-01, -6.07293844e-01,
       -7.24249780e-02, -2.16324091e-01, -1.51959628e-01,  1.07101649e-01,
       -1.47670805e-01,  3.24044973e-02, -2.07642734e-01,  1.40551478e-01,
        1.40442073e-01,  3.00905138e-01,  1.00222036e-01, -1.16262637e-01,
       -8.72700155e-01,  9.62216109e-02,  2.91607957e-02, -4.04043138e-01,
        1.75347671e-01,  2.02022493e-01,  2.55887657e-01,  6.44652903e-01,
       -1.80326700e-01,  7.75810182e-01,  5.56404586e-04, -6.60537109e-02,
        2.24963605e-01, -1.06508508e-01, -2.60277390e-01, -2.67778039e-01,
       -1.75908759e-01, -1.89946830e-01,  1.64246798e-01,  1.83071032e-01,
       -1.60486013e-01,  3.88506979e-01,  3.60263661e-02,  1.06192611e-01,
        1.05379514e-01, -5.66331595e-02,  2.25229427e-01, -1.62022784e-01,
       -1.73190773e-01,  3.05156082e-01,  8.04419816e-02, -2.64469296e-01,
        3.94889653e-01, -1.85621768e-01,  3.46247792e-01,  8.24234337e-02,
        1.06785968e-02, -5.74074127e-02,  3.58915925e-01, -1.51824802e-01,
        2.85050333e-01, -5.53154588e-01, -5.15085399e-01,  4.63541858e-02,
        4.14885759e-01, -2.06452459e-02, -6.20120525e-01, -1.05763853e-01,
       -2.91325003e-01, -2.23313287e-01, -2.31189758e-01, -2.95567572e-01,
        2.37764418e-01,  5.69793820e-01, -4.25730720e-02,  1.13755852e-01,
       -1.00544266e-01,  9.34330225e-02, -4.24673975e-01,  1.32106636e-02,
        6.33335531e-01,  1.75807238e-01,  2.77264655e-01, -2.34185562e-01,
        1.43785506e-01, -2.73940802e-01, -2.66307831e-01,  1.41895413e-01,
       -1.46364853e-01,  9.58394036e-02,  9.17137042e-02, -7.73020625e-01,
        1.41464518e-02, -1.36510864e-01, -3.07542682e-01,  2.94472463e-02,
        1.67248577e-01,  2.17347920e-01, -3.74522954e-01,  1.75383717e-01,
        1.44942611e-01, -2.35130534e-01, -5.20189442e-02,  8.02142918e-02,
       -2.82324612e-01, -1.86824113e-01, -3.00274491e-01,  1.12874255e-01,
       -3.88515890e-01, -4.69162539e-02, -4.38472517e-02, -1.85968354e-02,
        5.99743366e-01,  2.22050473e-02,  1.69090688e-01, -2.70465463e-02,
        7.60951787e-02, -7.38663614e-01, -2.77509540e-01,  1.70018673e-01,
       -2.78798640e-01,  3.32233906e-01,  2.79137731e-01,  2.89680034e-01,
       -9.50919241e-02, -2.50368044e-02,  5.15446365e-01,  2.53125608e-01,
       -1.09971225e-01, -5.33671200e-01,  9.11812484e-03,  4.15172875e-01,
       -7.68126175e-02,  4.32633832e-02, -2.73506492e-02, -4.18631770e-02,
       -1.81232423e-01, -1.04928732e-01,  2.41104841e-01,  6.96348250e-02,
        2.39155293e-01,  3.01212996e-01,  1.12580732e-02,  9.10344720e-03,
        7.63856173e-01, -6.29195347e-02, -2.99893200e-01, -3.47636417e-02,
       -1.38979375e-01, -7.07477331e-02,  4.49675508e-02, -1.87486038e-01,
       -4.27129954e-01,  1.17707215e-01,  2.70452835e-02,  1.10765591e-01,
       -1.53856426e-01, -3.92132521e-01,  1.35329098e-01, -5.68010151e-01,
        1.95151530e-02, -2.49188855e-01, -6.72061555e-03, -7.42592394e-01,
       -1.49069130e-01,  1.01351030e-01, -2.58233219e-01, -1.77945733e-01],
      dtype=np.float32) + 3.1309943199157715)


with header:
    col1, col2, col3 = st.columns([1.5,1,1])
    with col1:
        st.title("Likeness Demo")
    with col2:
        st.write('')
        st.write('')
        st.image("microsoft_logo.png")
        
    with col3:
        st.write('')
        st.write('')
        st.image("cambridge_logo.png")

with body:
    #global picture
    picture = st.file_uploader(label="Upload Image Here:", type=['png', 'jpg', 'tiff'])
    if picture is not None:
        update_image()
